<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telemedicine Dashboard</title>
    <link rel="stylesheet" href="/dashboard.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <img src="/telemedicine-logo.png" alt="Telemedicine Logo">
            </div>
            <ul class="nav-links">
                <li><a href="/telemedicine/api/patients/dashboard">Dashboard</a></li>
                <li><a href="/telemedicine/api/patients/individual/edit">View Profile</a></li>
                <li><a href="/telemedicine/api/appointments/createAppointment">Book Appointment</a></li>
                <li><a href="/telemedicine/api/doctors/viewProviders">View Doctors</a></li>
                <li><button id="logoutButton">Logout</button></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <header>
                <small>Hello, <strong><span id="patientFirstnameHeader"></span></strong> â€” Welcome to your Telemedicine Dashboard</small>
            </header>

            <!-- Patient Profile Section -->
            <section id="patientSection" style="display: none;">
                <h3>Patient Profile</h3>
                <p><strong>First Name: </strong><span id="patientFirstnameProfile"></span></p>
                <p><strong>Last Name: </strong><span id="patientLastname"></span></p>
                <p><strong>Email: </strong><span id="patientEmail"></span></p>
                <p><strong>Address: </strong><span id="patientAddress"></span></p>
            </section>

            <!-- Stats Section -->
            <section class="stats-section">
                <div class="stat-card">
                    <p>Next Appointment</p>
                    <h2>None</h2>
                </div>
                <div class="stat-card">
                    <p>Available Providers</p>
                    <h2>5</h2>
                </div>
                <div class="stat-card">
                    <p>Messages</p>
                    <h2>3 Unread</h2>
                </div>
            </section>

            <!-- Appointment Section -->
            <section>
                <h3>Your Appointments</h3>
                <ul id="appointmentList"></ul>
            </section>
        </div>
    </div>

    <!-- Message Display -->
    <div id="message" style="display: none;"></div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const patientSection = document.getElementById('patientSection');
            const patientFirstnameHeader = document.getElementById('patientFirstnameHeader');
            const patientFirstnameProfile = document.getElementById('patientFirstnameProfile');
            const patientLastnameSpan = document.getElementById('patientLastname');
            const patientEmailSpan = document.getElementById('patientEmail');
            const patientAddressSpan = document.getElementById('patientAddress');
            const messageDiv = document.getElementById('message');
            const appointmentList = document.getElementById('appointmentList');

            // Display message function
            function showMessage(type, text) {
                messageDiv.style.display = 'block';
                messageDiv.style.color = type === 'success' ? 'green' : 'red';
                messageDiv.textContent = text;

                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }

            // Fetch and display patient profile data
            async function getPatient() {
                try {
                    const response = await fetch('/telemedicine/api/patients/individual', { method: 'GET' });

                    if (response.ok) {
                        const result = await response.json();
                        patientFirstnameHeader.textContent = result.patient.first_name;
                        patientFirstnameProfile.textContent = result.patient.first_name;
                        patientLastnameSpan.textContent = result.patient.last_name;
                        patientEmailSpan.textContent = result.patient.email;
                        patientAddressSpan.textContent = result.patient.address;
                        patientSection.style.display = 'block';
                    } else if (response.status === 401 || response.status === 403) {
                        window.location.href = '/telemedicine/api/patients/login';
                    } else {
                        const result = await response.json();
                        showMessage('failed', result.message || 'Failed to load patient data.');
                    }
                } catch (error) {
                    showMessage('failed', 'An error occurred while loading patient data.');
                    console.error('Error fetching patient data:', error);
                }
            }

            // Logout functionality
            document.getElementById('logoutButton').addEventListener('click', function() {
                fetch('/telemedicine/api/patients/logout', { method: 'GET' })
                    .then(response => {
                        if (!response.ok) throw new Error('Logout failed.');
                        return response.json();
                    })
                    .then(data => {
                        alert(data.message);
                        window.location.href = '/telemedicine/api/patients/login';
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred during logout.');
                    });
            });

            // View appointments safely
            async function loadAppointments() {
                try {
                    const response = await fetch('/telemedicine/api/appointments/view');
                    if (response.status === 401 || response.status === 403) {
                        window.location.href = '/telemedicine/api/patients/login';
                        return;
                    }

                    const appointments = await response.json();
                    appointmentList.innerHTML = '';

                    appointments.forEach(appointment => {
                        const li = document.createElement('li');

                        const doctorText = document.createElement('p');
                        doctorText.textContent = `Doctor: ${appointment.doctor_first_name} ${appointment.doctor_last_name}`;
                        li.appendChild(doctorText);

                        const dateText = document.createElement('p');
                        dateText.textContent = `Date: ${appointment.appointment_date}`;
                        li.appendChild(dateText);

                        const timeText = document.createElement('p');
                        timeText.textContent = `Time: ${appointment.appointment_time}`;
                        li.appendChild(timeText);

                        const cancelBtn = document.createElement('button');
                        cancelBtn.textContent = 'Cancel';
                        cancelBtn.onclick = () => cancelAppointment(appointment.id);
                        li.appendChild(cancelBtn);

                        appointmentList.appendChild(li);
                    });
                } catch (error) {
                    console.error('Error loading appointments:', error);
                }
            }

            // Cancel appointment
            async function cancelAppointment(appointmentId) {
                try {
                    const response = await fetch(`/telemedicine/api/appointments/cancel/${appointmentId}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    if (response.ok) {
                        alert(result.message);
                        loadAppointments();
                    } else {
                        alert(result.message || 'Failed to cancel appointment');
                    }
                } catch (error) {
                    console.error('Error canceling appointment:', error);
                }
            }

            // Run functions on page load
            getPatient();
            loadAppointments();
        });
    </script>
</body>
</html>
